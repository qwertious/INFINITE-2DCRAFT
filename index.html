<!DOCTYPE html>
<html>

<head>
    <title>Inmetanty</title>
    <!--favicon-->
    <link id="favicon" rel="shortcut icon" type="image/x-icon">
</head>

<body style="margin: 0;">
    <canvas id="view" style="background-color: black; position: absolute;" width="16" height="16"></canvas>
    <script>
        var width = 16;
        var height = 16;
        var ow = 16;
        var oh = 16;
        var scale = 16;
        var view = document.getElementById("view");
        var ctx = view.getContext("2d");
        var screen = "presents";
        var i = 0;
        var d = {};
        d[3] = {};
        var px = 0; //Number.MAX_SAFE_INTEGER - 8
        var py = 0;
        var inventory = {};
        var sc = 0;
        var lw = 0;
        var lh = 0;
        var ls = 64 * 64;
        var keyw = 0;
        var keya = 0;
        var keys = 0;
        var keyd = 0;

        var logo = new Image();
        var background = new Image();
        background.src = "assets/textures/background.png";
        var play = new Image();
        play.src = "assets/textures/play.png";
        var block = new Image();
        var favicon = new Image();
        var item = new Image();
        item.src = "assets/textures/item.png";
        var back = new Image();
        back.src = "assets/textures/back.png";
        var luminary = new Image();
        var music = new Audio();
        var font = new Image();
        document.addEventListener("keydown", function (e) {
            if (e.keyCode == 87) {
                keyw = 1;
            } else if (e.keyCode == 83) {
                keys = 1;
            } else if (e.keyCode == 65) {
                keyd = 1;
            } else if (e.keyCode == 68) {
                keya = 1;
            }
        });
        //add a listener for keyup
        document.addEventListener("keyup", function (e) {
            if (e.keyCode == 87) {
                keyw = 0;
            } else if (e.keyCode == 83) {
                keys = 0;
            } else if (e.keyCode == 65) {
                keyd = 0;
            } else if (e.keyCode == 68) {
                keya = 0;
            }
        });
        view.addEventListener("click", function (e) {
            if (screen == "prologue") {
                screen = "title";
                music.pause();
            } else if (screen == "presents") {
                if (document.cookie.includes("prologue=true")) {
                    screen = "title";
                } else {
                    screen = "prologue";
                }
                music.pause();
            } else if (screen == "title") {
                if (e.offsetX > ow + scale * 2 && e.offsetY > oh + scale * 8 && e.offsetX < ow + scale * 14 && e.offsetY < oh + scale * 10) {
                    screen = "game";
                    music.pause();
                }
            } else if (screen == "game") {
                for (var x1 = Math.floor(px / 16 - 1); x1 < Math.ceil(17 + px / 16); x1++) {
                    for (var y1 = Math.floor(-py / 16 - 1); y1 < Math.ceil(13 - py / 16); y1++) {
                        if (d[x1][y1] != "none") {
                            if (e.offsetX > (x1 + px / 16) * scale + ow && e.offsetY > (y1 + py / 16) * scale + oh && e.offsetX < (x1 + px / 16) * scale + scale + ow && e.offsetY < (y1 + py / 16) * scale + scale + oh) {
                                for (a = 0; a < inventory.length; a++) {
                                    if (inventory[a] == d[x1][y1]) {
                                    } else if (inventory[a] === undefined) {
                                        inventory[a] = d[x1][y1];
                                        break;
                                    }
                                }
                                if (d[x1][y1 + "s"] == true) {
                                    d[x1][y1] = "none";
                                    d[x1][y1 + "s"] = false;
                                } else {
                                    d[x1][y1 + "s"] = true;
                                }
                            }
                        }
                    }
                }
            }
        });
        window.addEventListener("contextmenu", function (e) {
            e.preventDefault();
            if (screen == "game") {
                for (var x1 = Math.floor(px - 1); x1 < Math.ceil(17 + px); x1++) {
                    for (var y1 = Math.floor(py - 1); y1 < Math.ceil(13 + py); y1++) {
                        if (d[x1][y1] == "none") {
                            if (e.offsetX > (x1 + px / 16) * scale + ow && e.offsetY > (y1 + py / 16) * scale + oh && e.offsetX < (x1 + px / 16) * scale + scale + ow && e.offsetY < (y1 + py / 16) * scale + scale + oh) {
                                d[x1][y1] = "dirt";
                            }
                        }
                    }
                }
            }
        });

        function loop() {
            ctx.FillStyle = "#000000";
            ctx.fillRect(0, 0, window.innerWidth, window.innerHeight);
            view.width = window.innerWidth;
            view.height = window.innerHeight;
            if (window.innerWidth * 3 / 4 > window.innerHeight) {
                width = window.innerHeight * 4 / 3;
                height = window.innerHeight;
                scale = window.innerHeight / 12;
            } else {
                width = window.innerWidth;
                height = window.innerWidth * 3 / 4;
                scale = window.innerWidth / 16;
            }
            ow = (window.innerWidth - width) / 2;
            oh = (window.innerHeight - height) / 2;
            if (screen == "presents") {
                ctx.fillStyle = "#808080";
                ctx.fillRect(ow, oh, width, height);
                favicon.src = "assets/textures/grass.png";
                document.getElementById("favicon").href = favicon.src;
                logo.src = "assets/textures/qwertious.png";
                ctx.imageSmoothingEnabled = false;
                ctx.drawImage(logo, ow, oh + scale * 4, width, scale * 2);
                write("presents", 12, 16);
            }
            if (screen == "prologue") {
                document.cookie = "prologue=true";
                logo.src = "assets/textures/prologue.png";
                ctx.imageSmoothingEnabled = false;
                ctx.drawImage(logo, ow, oh, width, height);
                write("  this", 14, 10);
                write(" is the", 14, 11);
                write("story of", 14, 12);
                write("~a man", 14, 13);
                write("~named", 14, 14);
                write(" epome.", 14, 15);
                if (music.paused) {
                    mp();
                }
            }
            if (screen == "title") {
                ctx.fillStyle = "#00ffff";
                ctx.fillRect(ow, oh, width, height);
                ctx.imageSmoothingEnabled = false;
                ctx.drawImage(background, ow - width / 2 + Math.sin(i / 256) * width / 2, oh - height / 2 + Math.sin(i * Math.sqrt(2) / 256) * height / 2, width * 2, height * 2);
                ctx.drawImage(play, ow + scale * 2, oh + scale * 8, scale * 12, scale * 2);
                logo.src = "assets/textures/logo.png";
                ctx.drawImage(logo, ow + scale + Math.sin(i / 64) * scale / 2, oh + scale + Math.sin(i / 64 * Math.sqrt(2)) * scale * 3 / 28, scale * 14 - Math.sin(i / 64) * scale, scale * 3 - Math.sin(i / 64 * Math.sqrt(2)) * scale * 3 / 14);
                if (music.paused) {
                    mp();
                }
            }
            if (screen == "game") {
                if (keyw == 1) {
                    py += 4;
                }
                if (keya == 1) {
                    px -= 4;
                }
                if (keys == 1) {
                    py -= 4;
                }
                if (keyd == 1) {
                    px += 4;
                }
                sc = i;
                while (sc > 8 * ls) {
                    sc -= 8 * ls;
                }
                if (Math.ceil(sc / ls) % 2 == 0) {
                    ctx.fillStyle = "#000000";
                    ctx.fillRect(ow, oh, width, height);
                } else {
                    ctx.fillStyle = "#00ffff";
                    ctx.fillRect(ow, oh, width, height);
                }
                if (sc < ls) {
                    luminary.src = "assets/textures/sun.png";
                } else if (sc > ls && sc < 2 * ls) {
                    luminary.src = "assets/textures/moon1.png";
                } else if (sc > 2 * ls && sc < 3 * ls) {
                    luminary.src = "assets/textures/sun.png";
                } else if (sc > 3 * ls && sc < 4 * ls) {
                    luminary.src = "assets/textures/moon2.png";
                } else if (sc > 4 * ls && sc < 5 * ls) {
                    luminary.src = "assets/textures/sun.png";
                } else if (sc > 5 * ls && sc < 6 * ls) {
                    luminary.src = "assets/textures/moon3.png";
                } else if (sc > 6 * ls && sc < 7 * ls) {
                    luminary.src = "assets/textures/sun.png";
                } else {
                    luminary.src = "assets/textures/moon4.png";
                }
                lw = 18 * sc / ls;
                while (lw > 18) {
                    lw -= 18;
                }
                lh = 14 * sc / ls;
                while (lh > 14) {
                    lh -= 14;
                }
                ctx.imageSmoothingEnabled = false;
                ctx.drawImage(luminary, ow + scale * lw - scale, oh + scale * lh - scale, scale, scale);
                for (var x = -Math.floor(px / 16 + 1); x < Math.ceil(17 - px / 16); x++) {
                    for (var y = -Math.floor(py / 16 + 1); y < Math.ceil(13 - py / 16); y++) {
                        if (d[x] === undefined) {
                            d[x] = {};
                        }
                        if (d[x][y] === undefined) {
                            if (y == ourworldg(x)) {
                                d[x][y] = "grass";
                                if (y < 0) {
                                    if (Math.floor(Math.sin(x * Math.sqrt(2) * 64 * 64)) == 0) {
                                        d[x][y - 1] = "blade";
                                    }
                                }
                            } else if (y > ourworldg(x)) {
                                d[x][y] = "dirt";
                                if (y - 3 > ourworldg(x)) {
                                    d[x][y] = "slate";
                                }
                            } else {
                                if (y >= 12) {
                                    d[x][y] = "water";
                                } else {
                                    d[x][y] = "none";
                                }
                            }
                        }
                        eval(d[x][y] + "i =" + "new Image()");
                        eval(d[x][y] + "i.src = \"assets/textures/" + d[x][y] + ".png\"");
                        if (d[x][y] == "none") {
                        } else if (d[x][y] == "water") {
                            wateri.src = "assets/textures/water.gif";
                            ctx.drawImage(wateri, ow + scale * (x + px / 16), oh + scale * (y + py / 16), scale, scale);
                        } else {
                            if (Math.ceil(sc / ls) % 2 == 0) {
                                ctx.fillRect(ow + scale * (x + px / 16), oh + scale * (y + py / 16), scale, scale);
                                ctx.globalAlpha = 0.5;
                            }
                            if (d[x][y + "s"] == true) {
                                ctx.fillStyle = "#000000";
                                ctx.fillRect(ow + scale * (x + px / 16), oh + scale * (y + py / 16), scale, scale);
                                ctx.globalAlpha /= 2;
                            }
                            eval("ctx.drawImage(" + d[x][y] + "i, ow + (x + px/16) * scale, oh + (y + py/16) * scale, scale, scale)");
                            ctx.globalAlpha = 1;
                        }
                        for (a1 = 0; a1 < 8; a1++) {
                            if (inventory[a1] === undefined) {
                                ctx.drawImage(back, ow + scale * (4 + a1), oh + scale * 11, scale, scale);
                            } else {
                                eval(inventory[a1] + "i =" + "new Image()");
                                eval(inventory[a1] + "i.src = \"assets/textures/" + inventory[a1] + ".png\"");
                                eval("ctx.drawImage(" + inventory[a1] + "i, ow + scale * (4 +a1), oh + scale*11, scale, scale)");
                            }
                            ctx.drawImage(item, ow + scale * (4 + a1), oh + scale * 11, scale, scale);
                        }
                    }
                }
                if (music.paused) {
                    mp();
                }
            }
            ctx.fillStyle = "#000000";
            ctx.fillRect(0, 0, ow, window.innerHeight);
            ctx.fillRect(ow + width, 0, ow, window.innerHeight);
            ctx.fillRect(0, 0, window.innerWidth, oh);
            ctx.fillRect(0, oh + height, window.innerWidth, oh);
            i++;
        }
        function ourworldg(a2) {
            return -
                Math.round(
                    (
                        Math.sin(Math.PI * Math.round(a2) / 2048) * 512
                        + Math.sin(Math.PI * Math.round(a2) * Math.sqrt(2) / 2048) * 512
                        + Math.sin(Math.PI * Math.round(a2) * Math.sqrt(3) / 2048) * 512
                    ) / 3
                    //+ 128 ^ (Math.sin(Math.PI * Math.round(a2) / 1024))
                    //+ 64 ^ (Math.sin(Math.PI * Math.round(a2) * Math.sqrt(2) / 512))
                    //+ 32 ^ (Math.sin(Math.PI * Math.round(a2) * Math.sqrt(3) / 256))
                    //- 1.5
                ) + 12;
        }
        function mp() {
            if (screen == "prologue") {
                music.src = "assets/sound/music/nostalgia.mp3";
            } else if (screen == "title") {
                var r = Math.floor(Math.random() * 3);
                if (r == 0) {
                    music.src = "assets/sound/music/qwertious_theme_song.mp3";
                } else if (r == 1) {
                    music.src = "assets/sound/music/metastable.mp3";
                } else {
                    music.src = "assets/sound/music/lorium.mp3";
                }
            } else if (screen == "game") {
                var r = Math.floor(Math.random() * 3);
                if (r == 0) {
                    music.src = "assets/sound/music/upbeat.mp3";
                } else if (r == 1) {
                    music.src = "assets/sound/music/metastable.mp3";
                } else {
                    music.src = "assets/sound/music/calm_and_simple.mp3";
                }
            }
            music.play();
        }
        function write(a3, b, c) {
            var space = 0;
            for (i1 = 0; i1 < a3.length; i1++) {
                var character = a3.charAt(i1);
                if (character == " ") {
                } else if (character == "~") {
                    space++;
                } else {
                    if (character == ".") {
                        character = "period";
                    }
                    eval(character + "c = new Image()");
                    eval(character + "c.src = \"assets/textures/" + character + ".png\"");
                    eval("ctx.drawImage(" + character + "c, ow + scale * (b +i1 + space/2)/2, oh + c*scale/2, scale/2, scale/2)");
                }
            }
        }
        setInterval(loop, 1000 / 64);
    </script>
</body>

</html>